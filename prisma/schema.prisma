// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}
enum Role {
  USER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum PaymentGateway {
  STRIPE
  PAYPAL
}


model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  password      String?
  role          Role      @default(USER)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  addresses     Address[]
  bookings      Booking[]
  reviews       Review[]

  @@index([email])
}

model Account {
  id                String @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}



model Location {
  id        String   @id @default(cuid())
  city      String   // Madrid, Barcelona...
  address   String   // Calle exacta
  capacity  Int      // Capacidad máxima física
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workshops Workshop[]

  @@index([city])
}



model Category {
  id        String     @id @default(cuid())
  name      String     @unique
  slug      String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  workshops WorkshopCategory[]
}

model WorkshopCategory {
  workshopId String
  categoryId String

  workshop Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([workshopId, categoryId])
}

model Workshop {
  id             String   @id @default(cuid())
  title          String
  slug           String   @unique
  description    String
  price          Float
  imageUrls      String[]
  videoUrls      String[]
  duration       Int      // minutos
  date           DateTime
  availableSlots Int
  locationId     String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  isActive       Boolean  @default(true)

  location       Location @relation(fields: [locationId], references: [id])
  bookings       Booking[]
  reviews        Review[]
  categories     WorkshopCategory[]
  coupons        CouponWorkshop[]

  @@index([date])
  @@index([locationId, date])
  @@index([isActive])
}

model Booking {
  id           String        @id @default(cuid())
  userId       String
  workshopId   String
  participants Int           @default(1)
  totalPrice   Float
  status       BookingStatus @default(PENDING)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user     User     @relation(fields: [userId], references: [id])
  workshop Workshop @relation(fields: [workshopId], references: [id])
  payment  Payment?

  @@index([userId])
  @@index([workshopId])
}

model Payment {
  id        String   @id @default(cuid())
  bookingId String   @unique
  gateway   PaymentGateway
  gatewayId String   @unique // stripe session id / paypal order id
  amount    Float
  currency  String   @default("EUR")
  status    String
  method    String?  // card / apple_pay / google_pay
  createdAt DateTime @default(now())

  booking Booking @relation(fields: [bookingId], references: [id])
}

model Coupon {
  id            String   @id @default(cuid())
  code          String   @unique
  description   String?
  discountType  DiscountType
  discountValue Float
  minPurchase   Float?
  validFrom     DateTime
  validUntil    DateTime
  usageLimit    Int?
  usedCount     Int      @default(0)
  appliesToAll  Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workshops CouponWorkshop[]

  @@index([code])
  @@index([validUntil])
}

model CouponWorkshop {
  couponId   String
  workshopId String

  coupon   Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  workshop Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  @@id([couponId, workshopId])
}

model Review {
  id         String   @id @default(cuid())
  rating     Int
  comment    String?
  images     String[]
  userId     String
  workshopId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  workshop Workshop @relation(fields: [workshopId], references: [id])

  @@index([workshopId])
  @@index([userId])
}

model Address {
  id        String   @id @default(cuid())
  street    String
  city      String
  zipCode   String
  country   String   @default("ES")
  userId    String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}